# 项目改造规划：RAG与记忆模块

根据《翻书小狗-PRD- v1.0》文档，现制定RAG模块和记忆模块的实现规划如下。

## 1. 记忆模块 (Memory Module)

此模块负责管理对话历史和用户关键信息，以提供连贯和个性化的交互体验。

### 1.1 短期记忆 (Short-term Memory)

-   **目标**: 记录最近的对话历史（如最近5-10轮），确保对话的连贯性。
-   **实现方式**: 在应用服务端的会话（Session）层级，维护一个固定长度的队列或列表。每次用户与AI交互后，将该轮对话（用户输入和AI回复）存入此队列。
-   **数据结构**: 建议采用类似 `[{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}]` 的格式，方便后续直接注入到模型Prompt中。

### 1.2 长期记忆 (Long-term Memory)

-   **目标**: 存储用户的核心信息，如用户画像、情绪趋势、重要事件等，实现长期个性化。
-   **实现方式**:
    1.  **数据库设计**: 在现有的 `models.py` 中定义一个新的模型，例如 `LongTermMemory`。
    2.  **字段定义**: 该模型应至少包含 `user_id` (关联用户), `profile_summary` (用户画像摘要), `emotion_trends` (情绪趋势记录，可以是JSON格式), `important_events` (用户标记或AI识别的重要事件列表)。
    3.  **数据更新**: 设计一个工具或后台任务，在每次对话结束后或定期（如每日）分析对话内容，提取并更新上述字段。

### 1.3 记忆调用

-   **目标**: 在对话中智能地引用历史记忆，提供个性化支持。
-   **实现方式**: 在每次生成回复前，构建一个上下文（Context）。此上下文应包含：
    1.  完整的短期记忆（最近N轮对话）。
    2.  从长期记忆中检索出的相关摘要信息（如“用户最近三天情绪低落”，“用户上周提到过论文焦虑”）。
    3.  将此上下文注入到主对话的Prompt中，引导模型生成更具个性化和关怀感的回复。

## 2. RAG 系统 (“翻书”工具)

此模块作为Agent的一个核心工具，在用户明确求助时，从专业知识库中检索信息并以“小狗”的口吻呈现。

### 2.1 知识库建设

-   **目标**: 建立一个包含权威心理学书籍和情绪管理技巧的向量知识库。
-   **任务**:
    1.  **收集资料**: 收集PRD中提到的权威心理学书籍、文章等文本资料。
    2.  **文本处理**: 将收集到的文本进行清洗和切块（Chunking），确保每个文本块的粒度适中。
    3.  **向量化**: 选择一个合适的文本嵌入模型（Embedding Model），将所有文本块转换为向量。
    4.  **存入数据库**: 将文本块原文和对应的向量存入一个向量数据库中（例如，可以使用轻量的ChromaDB或FAISS集成到当前项目中）。

### 2.2 检索与生成流程

-   **目标**: 根据用户求助，精确检索知识并以“小狗”口吻生成回复。
-   **实现流程**:
    1.  **工具定义**: 在 `tools` 目录下创建一个新的工具文件，如 `knowledge_base_search.py`。
    2.  **触发判断**: Agent的核心逻辑需要判断用户的意图。当检测到明确的求助信号（如“我该怎么办”、“有什么建议吗”等），则调用RAG工具。
    3.  **向量检索**: 工具接收用户的查询后，将查询文本同样进行向量化，然后在向量数据库中执行相似度搜索，返回最相关的N个知识文本块。
    4.  **结果注入Prompt**: 将检索到的N个文本块作为背景知识（Context），与用户的原始问题一起，构建一个新的Prompt。
    5.  **生成回复**: 调用大语言模型处理这个包含背景知识的Prompt。Prompt中需要明确指示模型：
        -   必须参考提供的背景知识来回答问题。
        -   将专业内容以“小狗翻书”的方式进行转述。
        -   回复要保持“小狗文学”的温暖、共情风格。
        -   引用内容限制在1-3句。
