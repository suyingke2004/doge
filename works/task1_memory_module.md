# 任务一：记忆模块实现

## 1. 目标

实现短期记忆和长期记忆功能，为Agent提供对话上下文和个性化基础。

## 2. 详细步骤

### 2.1 短期记忆

-   **任务**: 在 `app.py` 或相关应用主文件中，为每个用户会话（session）创建一个用于存储对话历史的变量。
-   **实现**: 使用一个 `collections.deque` 对象，并设置其最大长度（例如 `maxlen=10`）来自动管理最近的对话轮次。
-   **数据结构**: 每一轮对话保存为 `{"role": "user", "content": "..."}` 和 `{"role": "assistant", "content": "..."}` 的字典格式。

### 2.2 长期记忆

-   **任务**: 设计并实现用于存储用户长期信息的数据库模型。
-   **实现**:
    1.  **修改 `models.py`**: 添加一个新的 `LongTermMemory` 表模型。
    2.  **字段**: 包含 `id` (主键), `user_id` (外键关联用户), `profile_summary` (TEXT类型), `emotion_trends` (JSON类型), `important_events` (JSON类型)。
    3.  **数据库迁移**: 运行 `flask db migrate` 和 `flask db upgrade` (或相应的数据库迁移命令) 来更新数据库结构。

### 2.3 记忆调用逻辑

-   **任务**: 在Agent生成回复前，将短期和长期记忆整合到Prompt中。
-   **实现**: 创建一个辅助函数，该函数在调用大模型API之前执行。它会：
    1.  获取当前会话的短期记忆（完整的对话历史）。
    2.  根据 `user_id` 从 `LongTermMemory` 表中查询用户的长期记忆摘要。
    3.  将这两部分信息格式化后，作为上下文（Context）添加到主Prompt的顶部。

## 3. 验收标准

-   短期记忆能够正确记录和传递最近的对话历史。
-   长期记忆能够通过数据库进行读写操作。
-   Agent的Prompt中包含了从短期和长期记忆中提取的上下文信息。
