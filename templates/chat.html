<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新闻对话</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- 流星粒子容器 -->
    <div class="stars-container" id="stars-container"></div>
    
    <!-- 鼠标指针粒子容器 -->
    <div class="cursor-particles" id="cursor-particles"></div>
    
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 id="page-title">新闻对话</h1>
            <div>
                <button id="lang-toggle" class="lang-toggle-btn">English</button>
            </div>
        </div>
        
        <div class="main-container">
            <div class="history-sidebar" id="history-sidebar">
                <h3>聊天历史</h3>
                <ul id="history-list"></ul>
            </div>
            <div class="chat-main">
                <!-- 显示聊天历史 -->
                <div class="chat-window" id="chat-window">
                    {% for message in chat_history %}
                        {% if message.type == 'human' %}
                            <div class="chat-message user-message">
                                <img src="{{ url_for('static', filename='user.jpg') }}" alt="User Avatar" class="avatar">
                                <div class="message-content">
                                    <p>{{ message.content }}</p>
                                </div>
                            </div>
                        {% elif message.type == 'ai' %}
                            <div class="chat-message ai-message">
                                <img src="{{ url_for('static', filename='agent.jpg') }}" alt="Agent Avatar" class="avatar">
                                <div class="message-content">
                                    <div>{{ message.content_html | safe }}</div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- 统一的聊天输入表单 -->
                <form id="chat-form" class="chat-form">
                    <textarea id="chat-topic-input" name="topic" class="expanding-textarea" placeholder="输入您的问题..." required></textarea>
                    <button type="submit" id="chat-submit-btn">发送</button>
                </form>
                <a href="{{ url_for('new_chat') }}" class="back-link">开始新对话</a>
            </div>

            <!-- 模型选择侧边栏 -->
            <div id="model-selection-sidebar" class="model-selection-sidebar">
                <p>模型与参数</p>
                <form id="model-params-form">
                    <div class="form-group">
                        <label for="model-provider" id="model-provider-label">模型提供商</label>
                        <select name="model_provider" id="model-provider">
                            <option value="deepseek" {% if session.get('model_provider') == 'deepseek' %}selected{% endif %}>DeepSeek</option>
                            <option value="openai" {% if session.get('model_provider') == 'openai' %}selected{% endif %}>OpenAI</option>
                            <option value="zhipu" {% if session.get('model_provider') == 'zhipu' %}selected{% endif %}>Zhipu AI</option>
                            <option value="ali" {% if session.get('model_provider') == 'ali' %}selected{% endif %}>Alibaba Cloud</option>
                            <option value="moonshot" {% if session.get('model_provider') == 'moonshot' %}selected{% endif %}>Moonshot AI</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="model-name" id="model-name-label">模型</label>
                        <select name="model_name" id="model-name">
                            <!-- 动态生成 -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="maxiter" id="maxiter-label">最大迭代次数</label>
                        <input type="number" id="maxiter" name="maxiter" min="1" value="{{ session.get('maxiter', 128) }}">
                    </div>
                    
                    <!-- 隐藏的语言字段 -->
                    <input type="hidden" id="language-input" name="language" value="{{ session.get('language', 'zh') }}">
                </form>
                
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatForm = document.getElementById('chat-form');
            const chatWindow = document.getElementById('chat-window');
            const modelProviderSelect = document.getElementById('model-provider');
            const modelNameSelect = document.getElementById('model-name');
            const maxiterInput = document.getElementById('maxiter');
            const languageInput = document.getElementById('language-input');

            const modelOptions = {
                'deepseek': [
                    { value: 'deepseek-chat', text: 'deepseek-chat (默认)' },
                    { value: 'deepseek-coder', text: 'deepseek-coder' }
                ],
                'openai': [
                    { value: 'gpt-4o', text: 'gpt-4o (默认)' },
                    { value: 'gpt-4o-mini', text: 'gpt-4o-mini' },
                    { value: 'gpt-4-turbo', text: 'gpt-4-turbo' }
                ],
                'zhipu': [
                    { value: 'glm-4', text: 'glm-4 (默认)' },
                    { value: 'glm-4-air', text: 'glm-4-air' },
                    { value: 'glm-4-flash', text: 'glm-4-flash' }
                ],
                'ali': [
                    { value: 'qwen-max', text: 'qwen-max (默认)' },
                    { value: 'qwen-plus', text: 'qwen-plus' },
                    { value: 'qwen-turbo', text: 'qwen-turbo' }
                ],
                'moonshot': [
                    { value: 'moonshot-v1-8k', text: 'moonshot-v1-8k (默认)' },
                    { value: 'moonshot-v1-32k', text: 'moonshot-v1-32k' },
                    { value: 'moonshot-v1-128k', text: 'moonshot-v1-128k' }
                ]
            };

            function updateModelOptions() {
                const provider = modelProviderSelect.value;
                const models = modelOptions[provider] || [];
                const selectedModel = "{{ session.get('model_name', '') }}";
                
                modelNameSelect.innerHTML = '';
                
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    if (model.value === selectedModel) {
                        option.selected = true;
                    }
                    modelNameSelect.appendChild(option);
                });
            }

            updateModelOptions();
            modelProviderSelect.addEventListener('change', updateModelOptions);

            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const topicInputElement = document.getElementById('chat-topic-input');
                const topic = topicInputElement.value.trim();
                if (!topic) return;

                // 添加用户消息
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'chat-message user-message';
                userMessageDiv.innerHTML = `
                    <img src="{{ url_for('static', filename='user.jpg') }}" alt="User Avatar" class="avatar">
                    <div class="message-content"><p>${topic}</p></div>
                `;
                chatWindow.appendChild(userMessageDiv);
                topicInputElement.value = '';

                // 创建AI消息容器
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'chat-message ai-message';
                aiMessageDiv.innerHTML = `
                    <img src="{{ url_for('static', filename='agent.jpg') }}" alt="Agent Avatar" class="avatar">
                    <div class="message-content">
                        <div id="ai-response"></div>
                        <div class="status-indicator" style="display: none;"></div>
                    </div>
                `;
                chatWindow.appendChild(aiMessageDiv);
                
                const aiResponseDiv = aiMessageDiv.querySelector('#ai-response');
                const statusIndicator = aiMessageDiv.querySelector('.status-indicator');
                chatWindow.scrollTop = chatWindow.scrollHeight;

                // 收集表单数据
                const formData = new FormData();
                formData.append('topic', topic);
                formData.append('model_provider', modelProviderSelect.value);
                formData.append('model_name', modelNameSelect.value);
                formData.append('maxiter', maxiterInput.value);
                formData.append('language', languageInput.value);

                try {
                    const response = await fetch('/chat_stream', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let accumulatedText = '';
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            try {
                                const message = JSON.parse(line);
                                if (message.type === "status") {
                                    statusIndicator.textContent = message.content;
                                    statusIndicator.style.display = "block";
                                } else if (message.type === "output") {
                                    statusIndicator.style.display = "none";
                                    accumulatedText += message.content;
                                    aiResponseDiv.innerHTML = accumulatedText; // Use innerHTML to render potential HTML tags
                                }
                            } catch (e) {
                                accumulatedText += line;
                                aiResponseDiv.textContent = accumulatedText;
                            }
                        }
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    aiResponseDiv.textContent = '抱歉，发生错误: ' + error.message;
                }
            });

            // 其他脚本（如粒子效果、语言切换等）保持不变
        });

        // 加载聊天历史记录
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    const historyList = document.getElementById('history-list');
                    if (data.error) {
                        historyList.innerHTML = `<li>加载出错: ${data.error}</li>`;
                        return;
                    }
                    if (data.length === 0) {
                        historyList.innerHTML = '<li>无历史记录</li>';
                        return;
                    }
                    historyList.innerHTML = '';
                    data.forEach(item => {
                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = `/history/${item.id}`;
                        link.textContent = item.title;
                        listItem.appendChild(link);
                        historyList.appendChild(listItem);
                    });
                });
        });
    </script>
</body>
</html>