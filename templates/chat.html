<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新闻对话</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- 引入marked.js用于Markdown到HTML的转换 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- 流星粒子容器 -->
    <div class="stars-container" id="stars-container"></div>
    
    <!-- 鼠标指针粒子容器 -->
    <div class="cursor-particles" id="cursor-particles"></div>
    
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 id="page-title">新闻对话</h1>
            <div>
                <button id="lang-toggle" class="lang-toggle-btn">English</button>
            </div>
        </div>
        
        <div class="main-container">
            <div class="history-sidebar" id="history-sidebar">
                <h3>聊天历史</h3>
                <ul id="history-list"></ul>
            </div>
            <div class="chat-main">
                <!-- 显示聊天历史 -->
                <div class="chat-window" id="chat-window">
                    {% for message in chat_history %}
                        {% if message.type == 'human' %}
                            <div class="chat-message user-message">
                                <img src="{{ url_for('static', filename='user.jpg') }}" alt="User Avatar" class="avatar">
                                <div class="message-content">
                                    <p>{{ message.content }}</p>
                                </div>
                            </div>
                        {% elif message.type == 'ai' %}
                            <div class="chat-message ai-message">
                                <img src="{{ url_for('static', filename='agent.jpg') }}" alt="Agent Avatar" class="avatar">
                                <div class="message-content">
                                    <div>{{ message.content_html | safe }}</div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- 统一的聊天输入表单 -->
                <form id="chat-form" class="chat-form">
                    <textarea id="chat-topic-input" name="topic" class="expanding-textarea" placeholder="输入您的问题..." required></textarea>
                    <button type="submit" id="chat-submit-btn">发送</button>
                </form>
            </div>

            <!-- 模型选择侧边栏 -->
            <div id="model-selection-sidebar" class="model-selection-sidebar">
                <p>模型与参数</p>
                <form id="model-params-form">
                    <div class="form-group">
                        <label for="model-provider" id="model-provider-label">模型提供商</label>
                        <select name="model_provider" id="model-provider">
                            <option value="deepseek" {% if session.get('model_provider') == 'deepseek' %}selected{% endif %}>DeepSeek</option>
                            <option value="openai" {% if session.get('model_provider') == 'openai' %}selected{% endif %}>OpenAI</option>
                            <option value="zhipu" {% if session.get('model_provider') == 'zhipu' %}selected{% endif %}>Zhipu AI</option>
                            <option value="ali" {% if session.get('model_provider') == 'ali' %}selected{% endif %}>Alibaba Cloud</option>
                            <option value="moonshot" {% if session.get('model_provider') == 'moonshot' %}selected{% endif %}>Moonshot AI</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="model-name" id="model-name-label">模型</label>
                        <select name="model_name" id="model-name">
                            <!-- 动态生成 -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="maxiter" id="maxiter-label">最大迭代次数</label>
                        <input type="number" id="maxiter" name="maxiter" min="1" value="{{ session.get('maxiter', 128) }}">
                    </div>
                    
                    <!-- 隐藏的语言字段 -->
                    <input type="hidden" id="language-input" name="language" value="{{ session.get('language', 'zh') }}">
                </form>
                
                <!-- 新对话按钮移到这里 -->
                <a href="{{ url_for('new_chat') }}" class="new-chat-link">开始新对话</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatForm = document.getElementById('chat-form');
            const chatWindow = document.getElementById('chat-window');
            const modelProviderSelect = document.getElementById('model-provider');
            const modelNameSelect = document.getElementById('model-name');
            const maxiterInput = document.getElementById('maxiter');
            const languageInput = document.getElementById('language-input');

            const modelOptions = {
                'deepseek': [
                    { value: 'deepseek-chat', text: 'deepseek-chat (默认)' },
                    { value: 'deepseek-coder', text: 'deepseek-coder' }
                ],
                'openai': [
                    { value: 'gpt-4o', text: 'gpt-4o (默认)' },
                    { value: 'gpt-4o-mini', text: 'gpt-4o-mini' },
                    { value: 'gpt-4-turbo', text: 'gpt-4-turbo' }
                ],
                'zhipu': [
                    { value: 'glm-4', text: 'glm-4 (默认)' },
                    { value: 'glm-4-air', text: 'glm-4-air' },
                    { value: 'glm-4-flash', text: 'glm-4-flash' }
                ],
                'ali': [
                    { value: 'qwen-max', text: 'qwen-max (默认)' },
                    { value: 'qwen-plus', text: 'qwen-plus' },
                    { value: 'qwen-turbo', text: 'qwen-turbo' }
                ],
                'moonshot': [
                    { value: 'moonshot-v1-8k', text: 'moonshot-v1-8k (默认)' },
                    { value: 'moonshot-v1-32k', text: 'moonshot-v1-32k' },
                    { value: 'moonshot-v1-128k', text: 'moonshot-v1-128k' }
                ]
            };

            function updateModelOptions() {
                const provider = modelProviderSelect.value;
                const models = modelOptions[provider] || [];
                const selectedModel = "{{ session.get('model_name', '') }}";
                
                modelNameSelect.innerHTML = '';
                
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    if (model.value === selectedModel) {
                        option.selected = true;
                    }
                    modelNameSelect.appendChild(option);
                });
            }

            updateModelOptions();
            modelProviderSelect.addEventListener('change', updateModelOptions);

            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const topicInputElement = document.getElementById('chat-topic-input');
                const topic = topicInputElement.value.trim();
                if (!topic) return;

                // 添加用户消息
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'chat-message user-message';
                userMessageDiv.innerHTML = `
                    <img src="{{ url_for('static', filename='user.jpg') }}" alt="User Avatar" class="avatar">
                    <div class="message-content"><p>${topic}</p></div>
                `;
                chatWindow.appendChild(userMessageDiv);
                topicInputElement.value = '';

                // 创建AI消息容器
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'chat-message ai-message';
                aiMessageDiv.innerHTML = `
                    <img src="{{ url_for('static', filename='agent.jpg') }}" alt="Agent Avatar" class="avatar">
                    <div class="message-content">
                        <div class="ai-response-content"></div>
                        <div class="status-indicator" style="display: none;"></div>
                    </div>
                `;
                chatWindow.appendChild(aiMessageDiv);
                
                const aiResponseDiv = aiMessageDiv.querySelector('.ai-response-content');
                const statusIndicator = aiMessageDiv.querySelector('.status-indicator');
                chatWindow.scrollTop = chatWindow.scrollHeight;

                // 收集表单数据
                const formData = new FormData();
                formData.append('topic', topic);
                formData.append('model_provider', modelProviderSelect.value);
                formData.append('model_name', modelNameSelect.value);
                formData.append('maxiter', maxiterInput.value);
                formData.append('language', languageInput.value);

                try {
                    const response = await fetch('/chat_stream', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let accumulatedText = '';
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            try {
                                const message = JSON.parse(line);
                                if (message.type === "status") {
                                    statusIndicator.textContent = message.content;
                                    statusIndicator.style.display = "block";
                                } else if (message.type === "output") {
                                    statusIndicator.style.display = "none";
                                    accumulatedText += message.content;
                                    // 使用marked库将Markdown转换为HTML
                                    aiResponseDiv.innerHTML = marked.parse(accumulatedText);
                                }
                            } catch (e) {
                                accumulatedText += line;
                                aiResponseDiv.innerHTML = accumulatedText;
                            }
                        }
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    aiResponseDiv.textContent = '抱歉，发生错误: ' + error.message;
                }
            });

            });

        // 粒子效果实现
        document.addEventListener('DOMContentLoaded', function() {
            // 流星粒子效果
            const starsContainer = document.getElementById('stars-container');
            
            function createStar() {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // 增大流星尺寸 (2-4px)
                const size = Math.random() * 2 + 2;
                star.style.width = `${size}px`;
                star.style.height = `${size * 3}px`; // 拉长高度
                
                // 随机位置 (顶部和右侧)
                const startX = Math.random() * window.innerWidth;
                const startY = -20; // 从顶部稍微上面开始
                star.style.left = `${startX}px`;
                star.style.top = `${startY}px`;
                
                // 缩短动画时长 (1-3秒)以增加密度
                const duration = Math.random() * 2 + 1;
                star.style.animationDuration = `${duration}s`;
                
                // 减少随机延迟以增加连续性
                const delay = Math.random() * 2;
                star.style.animationDelay = `${delay}s`;
                
                starsContainer.appendChild(star);
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (star.parentNode) {
                        star.parentNode.removeChild(star);
                    }
                }, duration * 1000);
            }
            
            // 创建初始流星
            for (let i = 0; i < 30; i++) {
                setTimeout(createStar, Math.random() * 2000);
            }
            
            // 增加创建新流星的频率
            setInterval(createStar, 150);
            
            // 鼠标指针粒子效果
            const cursorParticles = document.getElementById('cursor-particles');
            const particles = [];
            const particleCount = 30; // 增加粒子数量
            
            // 创建粒子池
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('cursor-particle');
                particle.style.width = '6px'; // 增大粒子尺寸
                particle.style.height = '6px';
                particle.style.opacity = '0';
                // 改为淡蓝色
                particle.style.backgroundColor = 'rgba(173, 216, 230, 0.7)';
                cursorParticles.appendChild(particle);
                particles.push({
                    element: particle,
                    x: 0,
                    y: 0,
                    angle: 0,
                    speed: 0,
                    size: Math.random() * 3 + 2, // 增大尺寸范围
                    life: 0,
                    active: false
                });
            }
            
            document.addEventListener('mousemove', function(e) {
                // 激活多个未使用的粒子以增强效果
                let activated = 0;
                for (let i = 0; i < particles.length && activated < 3; i++) {
                    if (!particles[i].active) {
                        particles[i].active = true;
                        particles[i].x = e.clientX;
                        particles[i].y = e.clientY;
                        particles[i].angle = Math.random() * Math.PI * 2;
                        particles[i].speed = Math.random() * 3 + 1;
                        particles[i].life = 40; // 增加生命周期
                        particles[i].element.style.width = `${particles[i].size}px`;
                        particles[i].element.style.height = `${particles[i].size}px`;
                        activated++;
                    }
                }
            });
            
            // 粒子动画循环
            function animateParticles() {
                for (let i = 0; i < particles.length; i++) {
                    if (particles[i].active) {
                        particles[i].x += Math.cos(particles[i].angle) * particles[i].speed;
                        particles[i].y += Math.sin(particles[i].angle) * particles[i].speed;
                        particles[i].life--;
                        
                        particles[i].element.style.left = `${particles[i].x}px`;
                        particles[i].element.style.top = `${particles[i].y}px`;
                        particles[i].element.style.opacity = `${particles[i].life / 40}`; // 调整透明度计算
                        
                        if (particles[i].life <= 0) {
                            particles[i].active = false;
                            particles[i].element.style.opacity = '0';
                        }
                    }
                }
                requestAnimationFrame(animateParticles);
            }
            
            animateParticles();
        });

        // 语言切换功能
        document.addEventListener('DOMContentLoaded', function() {
            const langToggleBtn = document.getElementById('lang-toggle');
            const languageInput = document.getElementById('language-input');
            const pageTitle = document.getElementById('page-title');
            const historySidebarTitle = document.querySelector('.history-sidebar h3');
            const modelSidebarTitle = document.querySelector('.model-selection-sidebar p');
            const modelProviderLabel = document.getElementById('model-provider-label');
            const modelNameLabel = document.getElementById('model-name-label');
            const maxiterLabel = document.getElementById('maxiter-label');
            const chatInputPlaceholder = document.getElementById('chat-topic-input');
            const chatSubmitBtn = document.getElementById('chat-submit-btn');
            const newChatLink = document.querySelector('.new-chat-link');
            
            // 中英文文本映射
            const translations = {
                'zh': {
                    'page-title': '新闻对话',
                    'history-title': '聊天历史',
                    'model-title': '模型与参数',
                    'model-provider': '模型提供商',
                    'model-name': '模型',
                    'maxiter': '最大迭代次数',
                    'input-placeholder': '输入您的问题...',
                    'submit-btn': '发送',
                    'new-chat': '开始新对话'
                },
                'en': {
                    'page-title': 'News Chat',
                    'history-title': 'Chat History',
                    'model-title': 'Model & Parameters',
                    'model-provider': 'Model Provider',
                    'model-name': 'Model',
                    'maxiter': 'Max Iterations',
                    'input-placeholder': 'Enter your question...',
                    'submit-btn': 'Send',
                    'new-chat': 'Start New Chat'
                }
            };
            
            if (langToggleBtn && languageInput) {
                // 设置按钮初始文本
                langToggleBtn.textContent = languageInput.value === 'zh' ? 'English' : '中文';
                
                // 更新所有文本元素
                function updateTexts(lang) {
                    const t = translations[lang];
                    pageTitle.textContent = t['page-title'];
                    if (historySidebarTitle) historySidebarTitle.textContent = t['history-title'];
                    if (modelSidebarTitle) modelSidebarTitle.textContent = t['model-title'];
                    if (modelProviderLabel) modelProviderLabel.textContent = t['model-provider'];
                    if (modelNameLabel) modelNameLabel.textContent = t['model-name'];
                    if (maxiterLabel) maxiterLabel.textContent = t['maxiter'];
                    if (chatInputPlaceholder) chatInputPlaceholder.placeholder = t['input-placeholder'];
                    if (chatSubmitBtn) chatSubmitBtn.textContent = t['submit-btn'];
                    if (newChatLink) newChatLink.textContent = t['new-chat'];
                }
                
                // 初始化文本
                updateTexts(languageInput.value);
                
                // 添加点击事件监听器
                langToggleBtn.addEventListener('click', function() {
                    if (languageInput.value === 'zh') {
                        languageInput.value = 'en';
                        langToggleBtn.textContent = '中文';
                    } else {
                        languageInput.value = 'zh';
                        langToggleBtn.textContent = 'English';
                    }
                    updateTexts(languageInput.value);
                });
            }
        });

        // 加载聊天历史记录
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    const historyList = document.getElementById('history-list');
                    if (data.error) {
                        historyList.innerHTML = `<li>加载出错: ${data.error}</li>`;
                        return;
                    }
                    if (data.length === 0) {
                        historyList.innerHTML = '<li>无历史记录</li>';
                        return;
                    }
                    historyList.innerHTML = '';
                    data.forEach(item => {
                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = `/history/${item.id}`;
                        // 截取标题的前30个字符，如果超过则添加省略号
                        const title = item.title.length > 30 ? item.title.substring(0, 30) + '...' : item.title;
                        link.textContent = title;
                        listItem.appendChild(link);
                        historyList.appendChild(listItem);
                    });
                });
        });
    </script>
</body>
</html>